name: Smart Contracts CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'Backend/Droppio.sol'
      - '.github/workflows/contracts.yml'
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        type: choice
        options:
          - sepolia
          - mainnet

jobs:
  verify-contract:
    name: Verify Contract
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Foundry
        uses: foundry-actions/setup-foundry@v1
        with:
          version: nightly

      - name: Install dependencies
        run: |
          forge install --no-commit

      - name: Compile contracts
        run: forge build

      - name: Run tests (if any)
        run: forge test || echo "No tests found"

  deploy-sepolia:
    name: Deploy to Base Sepolia
    runs-on: ubuntu-latest
    needs: verify-contract
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.network == 'sepolia')
    defaults:
      run:
        working-directory: ./Backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Foundry
        uses: foundry-actions/setup-foundry@v1
        with:
          version: nightly

      - name: Deploy to Base Sepolia
        run: |
          forge script script/Deploy.sol:DeployScript \
            --rpc-url ${{ secrets.BASE_SEPOLIA_RPC_URL }} \
            --private-key ${{ secrets.DEPLOYER_PRIVATE_KEY_TESTNET }} \
            --broadcast \
            --verify \
            --etherscan-api-key ${{ secrets.BASESCAN_API_KEY }}
        env:
          CHAIN_ID: '84532'

      - name: Save contract address
        run: |
          echo "CONTRACT_ADDRESS=$(forge script script/Deploy.sol:DeployScript --rpc-url ${{ secrets.BASE_SEPOLIA_RPC_URL }} --private-key ${{ secrets.DEPLOYER_PRIVATE_KEY_TESTNET }} --broadcast | grep -oP 'Deployed to: \K[0-9a-fA-Fx]+')" >> $GITHUB_ENV

  deploy-mainnet:
    name: Deploy to Base Mainnet
    runs-on: ubuntu-latest
    needs: verify-contract
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.network == 'mainnet')
    defaults:
      run:
        working-directory: ./Backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Foundry
        uses: foundry-actions/setup-foundry@v1
        with:
          version: nightly

      - name: Deploy to Base Mainnet
        run: |
          forge script script/Deploy.sol:DeployScript \
            --rpc-url ${{ secrets.BASE_MAINNET_RPC_URL }} \
            --private-key ${{ secrets.DEPLOYER_PRIVATE_KEY_PRODUCTION }} \
            --broadcast \
            --verify \
            --etherscan-api-key ${{ secrets.BASESCAN_API_KEY }}
        env:
          CHAIN_ID: '8453'

      - name: Save contract address
        run: |
          echo "CONTRACT_ADDRESS=$(forge script script/Deploy.sol:DeployScript --rpc-url ${{ secrets.BASE_MAINNET_RPC_URL }} --private-key ${{ secrets.DEPLOYER_PRIVATE_KEY_PRODUCTION }} --broadcast | grep -oP 'Deployed to: \K[0-9a-fA-Fx]+')" >> $GITHUB_ENV

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [verify-contract, deploy-sepolia, deploy-mainnet]
    if: failure()
    steps:
      - name: Notify Slack (Optional)
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Contract deployment failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Contract Deployment Failed*\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

